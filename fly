-- Các biến toàn cục
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rigType = humanoid.RigType
local part = rigType == Enum.HumanoidRigType.R6 and character:WaitForChild("Torso") or character:WaitForChild("UpperTorso")

local flying = false
local autoPlay = false          -- Tự động điều hướng đến người chơi gần nhất
local phaseActive = false       -- Chế độ "xuyên tường"
local seaActive = false         -- Chế độ tự cứu khi máu yếu
local seaOrigin = nil           -- Vị trí ban đầu khi kích hoạt /sea

local baseSpeed = 20            -- tốc độ cơ bản
local speedMultiplier = 1       -- hệ số nhân tốc độ (điều chỉnh bằng nút + và –)
local verticalSpeed = 0         -- vận tốc dọc (điều chỉnh bằng nút UP/DOWN)
local seaUpSpeed = 100          -- vận tốc bay tự động khi máu dưới 50%

local bodyGyro, bodyVelocity  -- dùng cho chế độ bay

---------------------------------------------------
-- Tạo GUI
local main = Instance.new("ScreenGui")
main.Name = "FlyGUI"
main.Parent = player:WaitForChild("PlayerGui")
main.ResetOnSpawn = false

-- Frame chứa GUI (đủ rộng để chứa thêm nút Auto, Phase)
local Frame = Instance.new("Frame")
Frame.Parent = main
Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
Frame.BorderColor3 = Color3.fromRGB(103, 221, 213)
Frame.Position = UDim2.new(0.1, 0, 0.38, 0)
Frame.Size = UDim2.new(0, 340, 0, 70)
Frame.Active = true
Frame.Draggable = true

-- Nút UP
local up = Instance.new("TextButton")
up.Name = "up"
up.Parent = Frame
up.BackgroundColor3 = Color3.fromRGB(79, 255, 152)
up.Size = UDim2.new(0, 44, 0, 28)
up.Position = UDim2.new(0, 0, 0, 0)
up.Font = Enum.Font.SourceSans
up.Text = "UP"
up.TextColor3 = Color3.fromRGB(0,0,0)
up.TextSize = 14

-- Nút DOWN
local down = Instance.new("TextButton")
down.Name = "down"
down.Parent = Frame
down.BackgroundColor3 = Color3.fromRGB(215, 255, 121)
down.Size = UDim2.new(0, 44, 0, 28)
down.Position = UDim2.new(0, 0, 0.5, 0)
down.Font = Enum.Font.SourceSans
down.Text = "DOWN"
down.TextColor3 = Color3.fromRGB(0,0,0)
down.TextSize = 14

-- Nút Auto (tự điều hướng)
local autoButton = Instance.new("TextButton")
autoButton.Name = "autoButton"
autoButton.Parent = Frame
autoButton.BackgroundColor3 = Color3.fromRGB(200,200,255)
autoButton.Size = UDim2.new(0, 56, 0, 28)
autoButton.Position = UDim2.new(0.25, 0, 0, 0)
autoButton.Font = Enum.Font.SourceSans
autoButton.Text = "Auto ❎"
autoButton.TextColor3 = Color3.fromRGB(0,0,0)
autoButton.TextSize = 14

-- Nút Fly (toggle)
local flyButton = Instance.new("TextButton")
flyButton.Name = "flyButton"
flyButton.Parent = Frame
flyButton.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
flyButton.Size = UDim2.new(0, 56, 0, 28)
flyButton.Position = UDim2.new(0.25, 0, 0.5, 0)
flyButton.Font = Enum.Font.SourceSans
flyButton.Text = "fly"
flyButton.TextColor3 = Color3.fromRGB(0,0,0)
flyButton.TextSize = 14

-- Nút Phase (xuyên tường)
local phaseButton = Instance.new("TextButton")
phaseButton.Name = "phaseButton"
phaseButton.Parent = Frame
phaseButton.BackgroundColor3 = Color3.fromRGB(255,200,200)
phaseButton.Size = UDim2.new(0, 56, 0, 28)
phaseButton.Position = UDim2.new(0.5, 0, 0, 0)
phaseButton.Font = Enum.Font.SourceSans
phaseButton.Text = "Phase ❎"
phaseButton.TextColor3 = Color3.fromRGB(0,0,0)
phaseButton.TextSize = 14

-- Nút tăng tốc (+)
local plus = Instance.new("TextButton")
plus.Name = "plus"
plus.Parent = Frame
plus.BackgroundColor3 = Color3.fromRGB(133, 145, 255)
plus.Size = UDim2.new(0, 45, 0, 28)
plus.Position = UDim2.new(0.75, 0, 0, 0)
plus.Font = Enum.Font.SourceSans
plus.Text = "+"
plus.TextColor3 = Color3.fromRGB(0,0,0)
plus.TextSize = 14

-- Nút giảm tốc (–)
local minus = Instance.new("TextButton")
minus.Name = "minus"
minus.Parent = Frame
minus.BackgroundColor3 = Color3.fromRGB(123, 255, 247)
minus.Size = UDim2.new(0, 45, 0, 29)
minus.Position = UDim2.new(0.75, 0, 0.5, 0)
minus.Font = Enum.Font.SourceSans
minus.Text = "–"
minus.TextColor3 = Color3.fromRGB(0,0,0)
minus.TextSize = 14

-- Hiển thị tốc độ (speed multiplier)
local speedLabel = Instance.new("TextLabel")
speedLabel.Name = "speedLabel"
speedLabel.Parent = Frame
speedLabel.BackgroundColor3 = Color3.fromRGB(255,85,0)
speedLabel.Size = UDim2.new(0, 44, 0, 28)
speedLabel.Position = UDim2.new(0.5, 0, 0.5, 0)
speedLabel.Font = Enum.Font.SourceSans
speedLabel.Text = tostring(speedMultiplier)
speedLabel.TextColor3 = Color3.fromRGB(0,0,0)
speedLabel.TextSize = 14

---------------------------------------------------
-- Hàm bật chế độ bay: tạo BodyGyro và BodyVelocity
local function startFlying()
	-- Cập nhật lại character và phần điều khiển nếu cần
	character = player.Character
	if not character then return end
	humanoid = character:FindFirstChildOfClass("Humanoid")
	part = rigType == Enum.HumanoidRigType.R6 and character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
	if not part then return end

	-- Tạo BodyGyro để điều khiển hướng
	bodyGyro = Instance.new("BodyGyro", part)
	bodyGyro.P = 9e4
	bodyGyro.maxTorque = Vector3.new(9e9,9e9,9e9)
	bodyGyro.cframe = workspace.CurrentCamera.CFrame
	
	-- Tạo BodyVelocity để điều khiển vận tốc
	bodyVelocity = Instance.new("BodyVelocity", part)
	bodyVelocity.MaxForce = Vector3.new(9e9,9e9,9e9)
	bodyVelocity.Velocity = Vector3.new(0,0.1,0)
	
	-- Tắt hoạt động của Humanoid để tránh rơi tự do
	humanoid.PlatformStand = true
	
	-- Vòng lặp cập nhật
	spawn(function()
		while flying and character and character.Parent do
			if autoPlay then
				-- Tìm người chơi gần nhất
				local closestTarget = nil
				local closestDistance = math.huge
				for _, p in ipairs(game.Players:GetPlayers()) do
					if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
						local dist = (p.Character.HumanoidRootPart.Position - part.Position).Magnitude
						if dist < closestDistance then
							closestDistance = dist
							closestTarget = p
						end
					end
				end
				if closestTarget and closestTarget.Character and closestTarget.Character:FindFirstChild("HumanoidRootPart") then
					local targetPos = closestTarget.Character.HumanoidRootPart.Position
					local direction = (targetPos - part.Position).unit
					bodyVelocity.Velocity = direction * baseSpeed * speedMultiplier
					bodyGyro.cframe = CFrame.new(part.Position, targetPos)
				else
					bodyVelocity.Velocity = Vector3.new(0,0,0)
				end
			else
				-- Chế độ bay thủ công
				local cam = workspace.CurrentCamera
				local moveDir = humanoid.MoveDirection
				local forward = cam.CFrame.LookVector
				local right = cam.CFrame.RightVector
				local horizontalVel = (moveDir.X * right + moveDir.Z * forward) * baseSpeed * speedMultiplier
				local finalVel = Vector3.new(horizontalVel.X, verticalSpeed, horizontalVel.Z)
				bodyVelocity.Velocity = finalVel
				bodyGyro.cframe = cam.CFrame
			end
			wait()
		end
		-- Khi tắt bay, phục hồi trạng thái
		if humanoid then
			humanoid.PlatformStand = false
		end
		if bodyGyro then bodyGyro:Destroy() end
		if bodyVelocity then bodyVelocity:Destroy() end
	end)
end

local function stopFlying()
	flying = false
end

---------------------------------------------------
-- Chức năng Phase: tắt va chạm của toàn bộ các phần của nhân vật
local function enablePhase()
	if character then
		for _, obj in pairs(character:GetDescendants()) do
			if obj:IsA("BasePart") then
				obj.CanCollide = false
			end
		end
	end
	phaseActive = true
end

local function disablePhase()
	if character then
		for _, obj in pairs(character:GetDescendants()) do
			if obj:IsA("BasePart") then
				obj.CanCollide = true
			end
		end
	end
	phaseActive = false
end

---------------------------------------------------
-- Xử lý nút Fly: Toggle bật/tắt chế độ bay
flyButton.MouseButton1Click:Connect(function()
	flying = not flying
	if flying then
		flyButton.Text = "Stop fly"
		startFlying()
	else
		flyButton.Text = "fly"
		stopFlying()
	end
end)

---------------------------------------------------
-- Xử lý nút Auto: Toggle tự điều hướng đến người chơi gần nhất
autoButton.MouseButton1Click:Connect(function()
	autoPlay = not autoPlay
	if autoPlay then
		autoButton.Text = "Auto ✅"
	else
		autoButton.Text = "Auto ❎"
	end
end)

---------------------------------------------------
-- Xử lý nút Phase: Toggle bật/tắt chế độ xuyên tường
phaseButton.MouseButton1Click:Connect(function()
	if phaseActive then
		disablePhase()
		phaseButton.Text = "Phase ❎"
	else
		enablePhase()
		phaseButton.Text = "Phase ✅"
	end
end)

---------------------------------------------------
-- Điều chỉnh tốc độ bay (nhân tốc độ)
plus.MouseButton1Click:Connect(function()
	speedMultiplier = speedMultiplier + 1
	speedLabel.Text = tostring(speedMultiplier)
end)
minus.MouseButton1Click:Connect(function()
	if speedMultiplier > 1 then
		speedMultiplier = speedMultiplier - 1
		speedLabel.Text = tostring(speedMultiplier)
	end
end)

---------------------------------------------------
-- Xử lý nút UP/DOWN để thay đổi vận tốc theo trục Y (chế độ bay thủ công)
up.MouseButton1Down:Connect(function()
	verticalSpeed = baseSpeed * speedMultiplier
end)
up.MouseButton1Up:Connect(function()
	verticalSpeed = 0
end)
down.MouseButton1Down:Connect(function()
	verticalSpeed = -baseSpeed * speedMultiplier
end)
down.MouseButton1Up:Connect(function()
	verticalSpeed = 0
end)

---------------------------------------------------
-- Chức năng /sea: Khi chat "/sea" kích hoạt chế độ cứu hộ khi máu yếu
player.Chatted:Connect(function(msg)
	msg = msg:lower()
	if msg == "/sea" then
		-- Lưu vị trí hiện tại của nhân vật
		if character and character:FindFirstChild("HumanoidRootPart") then
			seaOrigin = character.HumanoidRootPart.Position
		end
		seaActive = true
		-- Theo dõi máu của nhân vật
		spawn(function()
			while seaActive and character and character.Parent do
				local currentHealth = humanoid.Health
				-- Nếu máu dưới 50%, cập nhật vận tốc dọc bay lên với speed = seaUpSpeed
				if currentHealth < (humanoid.MaxHealth * 0.5) then
					if bodyVelocity then
						bodyVelocity.Velocity = Vector3.new(bodyVelocity.Velocity.X, seaUpSpeed, bodyVelocity.Velocity.Z)
					end
				elseif currentHealth > (humanoid.MaxHealth * 0.51) and seaOrigin then
					-- Khi máu hồi trên 51%, chuyển trở lại vị trí ban đầu và tắt chế độ /sea
					character:SetPrimaryPartCFrame(CFrame.new(seaOrigin))
					seaActive = false
				end
				wait(0.1)
			end
		end)
	end
	-- Chức năng /mode: Khi chat "/mode" tắt hết các chức năng và hủy script
	if msg == "/mode" then
		-- Tắt các chế độ đang bật
		flying = false
		autoPlay = false
		seaActive = false
		disablePhase()
		if humanoid then
			humanoid.PlatformStand = false
		end
		if bodyGyro then bodyGyro:Destroy() end
		if bodyVelocity then bodyVelocity:Destroy() end
		-- Hủy GUI
		if main then main:Destroy() end
		-- Hủy script
		script:Destroy()
	end
end)
